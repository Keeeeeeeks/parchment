function extend(){for(var t,e,i=arguments[0],r=1;r<arguments.length;)for(e in t=arguments[r++])i[e]=t[e];return i}function Class(){}function MemoryView(t,e,i){return"number"==typeof t?t=new ArrayBuffer(t):t.buffer&&(e|=0,void 0===i&&(i=t.byteLength-e),e+=t.byteOffset,t=t.buffer),extend(new DataView(t,e,i),{getUint8Array:function(t,e){return t+=this.byteOffset,new Uint8Array(this.buffer.slice(t,t+e))},getUint16Array:function(t,e){return t+=this.byteOffset,Uint8toUint16Array(new Uint8Array(this.buffer,t,2*e))},setUint8Array:function(t,e){e instanceof ArrayBuffer&&(e=new Uint8Array(e)),new Uint8Array(this.buffer,this.byteOffset,this.byteLength).set(e,t)},getFourCC:function(t){return String.fromCharCode(this.getUint8(t),this.getUint8(t+1),this.getUint8(t+2),this.getUint8(t+3))},setFourCC:function(t,e){this.setUint8(t,e.charCodeAt(0)),this.setUint8(t+1,e.charCodeAt(1)),this.setUint8(t+2,e.charCodeAt(2)),this.setUint8(t+3,e.charCodeAt(3))}})}function U2S16(t){return t<<16>>16}function S2U16(t){return 65535&t}function Uint8toUint16Array(t){for(var e=0,i=t.length,r=new Uint16Array(i/2);e<i;)r[e/2]=t[e++]<<8|t[e++];return r}Class.subClass=function(t){function e(){this.init&&this.init.apply(this,arguments)}return e.prototype=extend(Object.create(this.prototype),t),e.subClass=this.subClass,e.super=e.prototype.super=this.prototype,e};var utils={extend:extend,Class:Class,MemoryView:MemoryView,U2S16:U2S16,S2U16:S2U16,Uint8toUint16Array:Uint8toUint16Array},MemoryView$1=utils.MemoryView,IFF=utils.Class.subClass({init:function(t){if(this.type="",this.chunks=[],t){var e,i,r=MemoryView$1(t),s=12;if("FORM"!==r.getFourCC(0))throw new Error("Not an IFF file");for(this.type=r.getFourCC(8),e=r.getUint32(4)+8;s<e;){if((i=r.getUint32(s+4))<0||i+s>e)throw new Error("IFF chunk out of range");this.chunks.push({type:r.getFourCC(s),offset:s,data:r.getUint8Array(s+8,i)}),s+=8+i,i%2&&s++}}},write:function(){for(var t,e,i=12,r=0,s=12;r<this.chunks.length;)this.chunks[r].data.buffer&&(this.chunks[r].data=this.chunks[r].data.buffer),this.chunks[r].length=this.chunks[r].data.byteLength||this.chunks[r].data.length,(i+=8+this.chunks[r++].length)%2&&i++;for((t=MemoryView$1(i)).setFourCC(0,"FORM"),t.setUint32(4,i-8),t.setFourCC(8,this.type),r=0;r<this.chunks.length;)e=this.chunks[r++],t.setFourCC(s,e.type),t.setUint32(s+4,e.length),t.setUint8Array(s+8,e.data),(s+=8+e.length)%2&&s++;return t.buffer}}),Blorb=IFF.subClass({init:function(t){if(this.super.init.call(this,t),t){if("IFRS"!==this.type)throw new Error("Not a Blorb file");if("RIdx"!==this.chunks[0].type)throw new Error("Malformed Blorb: chunk 1 is not RIdx");for(var e=MemoryView$1(this.chunks[0].data),i=4;i<this.chunks[0].data.length;){if("Exec"===e.getFourCC(i)&&0===e.getUint32(i+4))return void(this.exec=this.chunks.filter((function(t){return t.offset===e.getUint32(i+8)}))[0]);i+=12}}}}),Quetzal=IFF.subClass({init:function(t){if(this.super.init.call(this,t),t){if("IFZS"!==this.type)throw new Error("Not a Quetzal savefile");for(var e,i,r,s=0;s<this.chunks.length;)e=this.chunks[s].type,i=this.chunks[s++].data,"CMem"===e||"UMem"===e?(this.memory=i,this.compressed="CMem"===e):"Stks"===e?this.stacks=i:"IFhd"===e&&(r=MemoryView$1(i.buffer),this.release=r.getUint16(0),this.serial=r.getUint8Array(2,6),this.checksum=r.getUint16(8),this.pc=16777215&r.getUint32(9))}},write:function(){this.type="IFZS";var t=MemoryView$1(13);return t.setUint16(0,this.release),t.setUint8Array(2,this.serial),t.setUint32(9,this.pc),t.setUint16(8,this.checksum),this.chunks=[{type:"IFhd",data:t},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this.super.write.call(this)}});function identify(t){var e,i,r,s=MemoryView$1(t);if("FORM"===s.getFourCC(0)&&"IFRS"===s.getFourCC(8)?(e=new Blorb(t)).exec&&(i=e.exec.type,t=e.exec.data,"GLUL"===i&&(r=(s=MemoryView$1(t)).getUint32(4)),"ZCOD"===i&&(r=t[0])):"Glul"===s.getFourCC(0)?(i="GLUL",r=s.getUint32(4)):(r=s.getUint8(0))>0&&r<9&&(i="ZCOD"),i&&r)return{format:i,version:r,data:t}}var file={IFF:IFF,Blorb:Blorb,Quetzal:Quetzal,identify:identify},commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(t,e){return t(e={exports:{}},e.exports),e.exports}var Class$1=utils.Class,U2S=utils.U2S16,Operand=Class$1.subClass({init:function(t,e){this.e=t,this.v=e},toString:function(){return this.v},U2S:function(){return U2S(this.v)}}),Variable=Operand.subClass({toString:function(){var t=this.v;return this.indirect?"e.indirect("+t+")":0===t?"s[--e.sp]":--t<15?"l["+t+"]":"e.m.getUint16("+(this.e.globals+2*(t-15))+")"},store:function(t){var e=this.v;return this.indirect?"e.indirect("+e+","+t+")":this.returnval?"e.variable("+e+","+t+")":0===e?"t="+t+";s[e.sp++]=t":--e<15?"l["+e+"]="+t:"e.ram.setUint16("+(this.e.globals+2*(e-15))+","+t+")"},U2S:function(){return"e.U2S("+this+")"}}),Opcode=Class$1.subClass({init:function(t,e,i,r,s,n){this.e=t,this.context=e,this.code=i,this.pc=r,this.labels=[this.pc+"/"+this.code],this.next=s,this.operands=n,this.post&&this.post()},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(t){return this.operands.join(t)},label:function(){return"/* "+this.labels.join()+" */ "}}),Stopper=Opcode.subClass({stopper:1}),Pauser=Stopper.subClass({post:function(){this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return"e.stop=1;e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}),PauserStorer=Pauser.subClass({storer:1,post:function(){this.storer=this.operands.pop(),this.origfunc=this.func,this.func=this.newfunc}}),BrancherLogic=Class$1.subClass({init:function(t,e){this.ops=t||[],this.code=e||"||"},toString:function(){for(var t,e=0,i=[];e<this.ops.length;)t=this.ops[e++],i.push(t.func?(t.iftrue?"":"!(")+t.func.apply(t,t.operands)+(t.iftrue?"":")"):t);return(this.invert?"(!(":"(")+i.join(this.code)+(this.invert?"))":")")}}),Brancher=Opcode.subClass({brancher:1,keyword:"if",post:function(){var t,e,i=this.operands.pop(),r=i[1];this.iftrue=i[0],0===r||1===r?t="e.ret("+r+")":(r+=this.next-2,this.context.targets.push(r),t="e.pc="+r),this.result=t+";return",this.offset=r,this.cond=new BrancherLogic([this]),this.context.ops.length&&((e=this.context.ops.pop()).offset===r?(this.cond.ops.unshift(e.cond),this.labels=e.labels,this.labels.push(this.pc+"/"+this.code)):this.context.ops.push(e))},toString:function(){var t=this.result;return t instanceof Context&&(this.e.options.debug&&(t.context=this.context),t+=t.stopper?"; return":"",this.result.ops.length>1&&(t="\n"+t+"\n",this.e.options.debug&&(t+=this.context.spacer))),this.label()+this.keyword+this.cond+" {"+t+"}"}}),BrancherStorer=Brancher.subClass({storer:1,post:function(){BrancherStorer.super.post.call(this),this.storer=this.operands.pop(),this.storer.returnval=1,this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),Storer=Opcode.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var t=Storer.super.toString.call(this);return this.storer?this.storer.store(t):t}}),Caller=Stopper.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),CallerStorer=Caller.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),Context=Class$1.subClass({init:function(t,e){this.e=t,this.pc=e,this.pre=[],this.ops=[],this.post=[],this.targets=[],t.options.debug&&(this.spacer="")},toString:function(){return this.e.options.debug?(this.context&&(this.spacer=this.context.spacer+"  "),this.pre.join("")+(this.ops.length>1?this.spacer:"")+this.ops.join(";\n"+this.spacer)+this.post.join("")):this.pre.join("")+this.ops.join(";")+this.post.join("")}}),RoutineContext=Context.subClass({toString:function(){return this.pre.unshift("var l=e.l,s=e.s,t=0;\n"),RoutineContext.super.toString.call(this)}});function opcode_builder(t,e,i){return i=i||{},e&&(i.func=e),t.subClass(i)}var ast={Operand:Operand,Variable:Variable,Opcode:Opcode,Stopper:Stopper,Pauser:Pauser,PauserStorer:PauserStorer,BrancherLogic:BrancherLogic,Brancher:Brancher,BrancherStorer:BrancherStorer,Storer:Storer,Caller:Caller,CallerStorer:CallerStorer,Context:Context,RoutineContext:RoutineContext,opcode_builder:opcode_builder},Variable$1=ast.Variable,Opcode$1=ast.Opcode,Stopper$1=ast.Stopper,Pauser$1=ast.Pauser,PauserStorer$1=ast.PauserStorer,Brancher$1=ast.Brancher,BrancherStorer$1=ast.BrancherStorer,Storer$1=ast.Storer,Caller$1=ast.Caller,CallerStorer$1=ast.CallerStorer,opcode_builder$1=ast.opcode_builder,simple_func=function(t){return""+t},stack_var=new Variable$1(commonjsGlobal.e,0),alwaysbranch=opcode_builder$1(Brancher$1,(function(){return 1})),not=opcode_builder$1(Storer$1,(function(t){return"e.S2U(~"+t+")"})),Indirect=Storer$1.subClass({storer:0,post:function(){var t=this.operands,e=t[0],i=e instanceof Variable$1;t[0]=new Variable$1(this.e,i?e:e.v),(i||0===e.v)&&(t[0].indirect=1),this.storer=142===this.code?t.pop():t.shift(),0===t.length&&t.push(stack_var)},func:simple_func}),Incdec=Opcode$1.subClass({func:function(t){var e=t.v-1,i=this.code%2?1:-1;return t instanceof Variable$1||e>14?"e.incdec("+t+","+i+")":(e<0?"e.s[e.sp-1]":"e.l["+e+"]")+(1===i?"++":"--")}}),V3SaveRestore=Stopper$1.subClass({brancher:1,toString:function(){return"e.stop=1;e."+(181===this.code?"save":"restore")+"("+(this.pc+1)+")"}}),V45Restore=opcode_builder$1(PauserStorer$1,(function(){return"e.restore("+(this.next-1)+")"})),V45Save=opcode_builder$1(PauserStorer$1,(function(){return"e.save("+(this.next-1)+")"})),opcodes=function(t){return{1:opcode_builder$1(Brancher$1,(function(){return 2===arguments.length?this.args("==="):"e.jeq("+this.args()+")"})),2:opcode_builder$1(Brancher$1,(function(t,e){return t.U2S()+"<"+e.U2S()})),3:opcode_builder$1(Brancher$1,(function(t,e){return t.U2S()+">"+e.U2S()})),4:opcode_builder$1(Brancher$1,(function(t,e){return"e.U2S(e.incdec("+t+",-1))<"+e.U2S()})),5:opcode_builder$1(Brancher$1,(function(t,e){return"e.U2S(e.incdec("+t+",1))>"+e.U2S()})),6:opcode_builder$1(Brancher$1,(function(){return"e.jin("+this.args()+")"})),7:opcode_builder$1(Brancher$1,(function(){return"e.test("+this.args()+")"})),8:opcode_builder$1(Storer$1,(function(){return this.args("|")})),9:opcode_builder$1(Storer$1,(function(){return this.args("&")})),10:opcode_builder$1(Brancher$1,(function(){return"e.test_attr("+this.args()+")"})),11:opcode_builder$1(Opcode$1,(function(){return"e.set_attr("+this.args()+")"})),12:opcode_builder$1(Opcode$1,(function(){return"e.clear_attr("+this.args()+")"})),13:Indirect,14:opcode_builder$1(Opcode$1,(function(){return"e.insert_obj("+this.args()+")"})),15:opcode_builder$1(Storer$1,(function(t,e){return"e.m.getUint16(e.S2U("+t+"+2*"+e.U2S()+"))"})),16:opcode_builder$1(Storer$1,(function(t,e){return"e.m.getUint8(e.S2U("+t+"+"+e.U2S()+"))"})),17:opcode_builder$1(Storer$1,(function(){return"e.get_prop("+this.args()+")"})),18:opcode_builder$1(Storer$1,(function(){return"e.find_prop("+this.args()+")"})),19:opcode_builder$1(Storer$1,(function(){return"e.find_prop("+this.args(",0,")+")"})),20:opcode_builder$1(Storer$1,(function(){return"e.S2U("+this.args("+")+")"})),21:opcode_builder$1(Storer$1,(function(){return"e.S2U("+this.args("-")+")"})),22:opcode_builder$1(Storer$1,(function(){return"e.S2U("+this.args("*")+")"})),23:opcode_builder$1(Storer$1,(function(t,e){return"e.S2U(parseInt("+t.U2S()+"/"+e.U2S()+"))"})),24:opcode_builder$1(Storer$1,(function(t,e){return"e.S2U("+t.U2S()+"%"+e.U2S()+")"})),25:CallerStorer$1,26:Caller$1,27:opcode_builder$1(Opcode$1,(function(){return"e.set_colour("+this.args()+")"})),28:opcode_builder$1(Stopper$1,(function(t,e){return"while(e.frames.length+1>"+e+"){e.frameptr=e.frames.pop()}return "+t})),128:opcode_builder$1(Brancher$1,(function(t){return t+"===0"})),129:opcode_builder$1(BrancherStorer$1,(function(t){return"e.get_sibling("+t+")"})),130:opcode_builder$1(BrancherStorer$1,(function(t){return"e.get_child("+t+")"})),131:opcode_builder$1(Storer$1,(function(t){return"e.get_parent("+t+")"})),132:opcode_builder$1(Storer$1,(function(t){return"e.get_prop_len("+t+")"})),133:Incdec,134:Incdec,135:opcode_builder$1(Opcode$1,(function(t){return"e.print(2,"+t+")"})),136:CallerStorer$1,137:opcode_builder$1(Opcode$1,(function(t){return"e.remove_obj("+t+")"})),138:opcode_builder$1(Opcode$1,(function(t){return"e.print(3,"+t+")"})),139:opcode_builder$1(Stopper$1,(function(t){return"return "+t})),140:opcode_builder$1(Stopper$1,(function(t){return"e.pc="+t.U2S()+"+"+(this.next-2)})),141:opcode_builder$1(Opcode$1,(function(t){return"e.print(2,"+t+"*"+this.e.addr_multipler+")"})),142:Indirect.subClass({storer:1}),143:t<5?not:Caller$1,176:opcode_builder$1(Stopper$1,(function(){return"return 1"})),177:opcode_builder$1(Stopper$1,(function(){return"return 0"})),178:opcode_builder$1(Opcode$1,(function(t){return"e.print(2,"+t+")"}),{printer:1}),179:opcode_builder$1(Stopper$1,(function(t){return"e.print(2,"+t+");e.print(1,13);return 1"}),{printer:1}),180:Opcode$1,181:t<4?V3SaveRestore:V45Save,182:t<4?V3SaveRestore:V45Restore,183:opcode_builder$1(Stopper$1,(function(){return"e.erase_window(-1);e.restart()"})),184:opcode_builder$1(Stopper$1,(function(t){return"return "+t}),{post:function(){this.operands.push(stack_var)}}),185:t<5?opcode_builder$1(Opcode$1,(function(){return"s[--e.sp]"})):opcode_builder$1(Storer$1,(function(){return"e.frames.length+1"})),186:opcode_builder$1(Pauser$1,(function(){return"e.quit=1;e.Glk.glk_exit()"})),187:opcode_builder$1(Opcode$1,(function(){return"e.print(1,13)"})),188:t<4?opcode_builder$1(Stopper$1,(function(){return"e.pc="+this.next+";e.v3_status()"})):Opcode$1,189:alwaysbranch,191:alwaysbranch,224:CallerStorer$1,225:opcode_builder$1(Opcode$1,(function(t,e,i){return"e.ram.setUint16(e.S2U("+t+"+2*"+e.U2S()+"),"+i+")"})),226:opcode_builder$1(Opcode$1,(function(t,e,i){return"e.ram.setUint8(e.S2U("+t+"+"+e.U2S()+"),"+i+")"})),227:opcode_builder$1(Opcode$1,(function(){return"e.put_prop("+this.args()+")"})),228:t<5?opcode_builder$1(Pauser$1,(function(){return"e.read(0,"+this.args()+")"})):opcode_builder$1(PauserStorer$1,(function(){return"e.read("+this.storer.v+","+this.args()+")"})),229:opcode_builder$1(Opcode$1,(function(t){return"e.print(4,"+t+")"})),230:opcode_builder$1(Opcode$1,(function(t){return"e.print(0,"+t.U2S()+")"})),231:opcode_builder$1(Storer$1,(function(t){return"e.random("+t.U2S()+")"})),232:opcode_builder$1(Storer$1,simple_func,{post:function(){this.storer=stack_var},storer:0}),233:Indirect,234:opcode_builder$1(Opcode$1,(function(t){return"e.split_window("+t+")"})),235:opcode_builder$1(Opcode$1,(function(t){return"e.set_window("+t+")"})),236:CallerStorer$1,237:opcode_builder$1(Opcode$1,(function(t){return"e.erase_window("+t.U2S()+")"})),238:opcode_builder$1(Opcode$1,(function(t){return"e.erase_line("+t+")"})),239:opcode_builder$1(Opcode$1,(function(t,e){return"e.set_cursor("+t+"-1,"+e+"-1)"})),240:opcode_builder$1(Opcode$1,(function(t){return"e.get_cursor("+t+")"})),241:opcode_builder$1(Opcode$1,(function(t){return"e.set_style("+t+")"})),242:Opcode$1,243:opcode_builder$1(Stopper$1,(function(){return"e.pc="+this.next+";e.output_stream("+this.args()+")"})),244:opcode_builder$1(Pauser$1,(function(){return"e.input_stream("+this.args()+")"})),245:Opcode$1,246:opcode_builder$1(PauserStorer$1,(function(){return"e.read_char("+this.storer.v+","+(this.args()||"1")+")"})),247:opcode_builder$1(BrancherStorer$1,(function(){return"e.scan_table("+this.args()+")"})),248:not,249:Caller$1,250:Caller$1,251:opcode_builder$1(Opcode$1,(function(){return"e.tokenise("+this.args()+")"})),252:opcode_builder$1(Opcode$1,(function(){return"e.encode_text("+this.args()+")"})),253:opcode_builder$1(Opcode$1,(function(){return"e.copy_table("+this.args()+")"})),254:opcode_builder$1(Opcode$1,(function(){return"e.print_table("+this.args()+")"})),255:opcode_builder$1(Brancher$1,(function(t){return"e.stack.getUint8(e.frameptr+5)&(1<<("+t+"-1))"})),1e3:V45Save,1001:V45Restore,1002:opcode_builder$1(Storer$1,(function(t,e){return"e.S2U(e.log_shift("+t+","+e.U2S()+"))"})),1003:opcode_builder$1(Storer$1,(function(t,e){return"e.S2U(e.art_shift("+t.U2S()+","+e.U2S()+"))"})),1004:opcode_builder$1(Storer$1,(function(t){return"e.set_font("+t+")"})),1009:opcode_builder$1(Storer$1,(function(){return"e.save_undo("+this.next+","+this.storer.v+")"})),1010:opcode_builder$1(Opcode$1,(function(){return"if(e.restore_undo())return"}),{storer:1}),1011:opcode_builder$1(Opcode$1,(function(t){return"e.print(1,"+t+")"})),1012:opcode_builder$1(Storer$1,(function(){return 3})),1013:opcode_builder$1(Opcode$1,(function(){return"e.set_true_colour("+this.args()+")"})),1014:Opcode$1.subClass({brancher:1}),1030:opcode_builder$1(Storer$1,(function(){return"e.gestalt("+this.args()+")"}))}};const extend$1=utils.extend,U2S$1=utils.U2S16,S2U=utils.S2U16;function clone(t){const e=t=>"object"==typeof t?clone(t):t,i={};if(Array.isArray(t))return t.map(e);for(let r in t)"buffer"!==r&&"str"!==r&&(i[r]=e(t[r]));return i}const littleEndian=function(){var t=new Uint8Array(2);return new Uint16Array(t.buffer)[0]=1,1===t[0]}();function fix_stack_endianness(t,e,i,r){if(littleEndian&&!r)for(;e<i;)t.setUint16(e,t.getUint16(e,1)),e+=2}var runtime={art_shift:function(t,e){return e>0?t<<e:t>>-e},call:function(t,e,i,r){if(0===t)return e>=0&&this.variable(e,0),this.pc=i;this.pc=t*this.addr_multipler;var s=this.m.getUint8(this.pc++),n=this.stack,o=0,a=this.frameptr;for(n.setUint16(a+6,this.sp),this.frames.push(a),a=this.frameptr=this.s.byteOffset+2*this.sp,n.setUint32(a,i<<8),n.setUint8(a+3,(e>=0?0:16)|s),n.setUint8(a+4,e>=0?e:0),n.setUint8(a+5,(1<<r.length)-1),this.make_stacks(),this.sp=0;o<s;)this.l[o]=o<r.length?r[o]:this.version<5?this.m.getUint16(this.pc+2*o):0,o++;this.version<5&&(this.pc+=2*s)},clear_attr:function(t,e){var i=this.objects+(this.version3?9:14)*t+e/8|0;this.ram.setUint8(i,this.m.getUint8(i)&~(128>>e%8))},copy_table:function(t,e,i){i=U2S$1(i);var r=this.ram,s=0,n=i<0;if(i=Math.abs(i),0!==e)if(n)for(;s<i;)r.setUint8(e+s,this.m.getUint8(t+s++));else r.setUint8Array(e,this.m.getUint8Array(t,i));else for(;s<i;)r.setUint8(t+s++,0)},do_autorestore:function(t){const e=this.Glk;e.restore_allstate(t.glk),this.io=t.io;const i=new e.RefBox;let r;for(;r=e.glk_window_iterate(r,i);)201===i.value&&(this.mainwin=r,r.linebuf&&(t.read_data.buffer=r.linebuf)),202===i.value&&(this.statuswin=r),203===i.value&&(this.upperwin=r);for(r=null;r=e.glk_stream_iterate(r,i);)210===i.value&&(this.io.streams[2].str=r),211===i.value&&(this.io.streams[4].str=r);this.restart(),this.restore_file(new Uint8Array(t.ram),1),this.read_data=t.read_data,this.xorshift_seed=t.xorshift_seed},do_autosave:function(t){if(!this.options.Dialog)throw new Error("A reference to Dialog is required");let e=null;(t||0)>=0&&(e={glk:this.Glk.save_allstate(),io:clone(this.io),ram:this.save_file(this.pc,1),read_data:clone(this.read_data),xorshift_seed:this.xorshift_seed}),this.options.Dialog.autosave_write(this.signature,e)},encode_text:function(t,e,i,r){this.ram.setUint8Array(r,this.encode(this.m.getUint8Array(t+i,e)))},extension_table:function(t,e){var i=this.extension;return!i||t>this.extension_count?0:(i+=2*t,void 0===e?this.m.getUint16(i):void this.ram.setUint16(i,e))},find_prop:function(t,e,i){var r,s,n=this.m,o=this.version3,a=0,h=n.getUint16(this.objects+(o?9:14)*t+(o?7:12));for(h+=2*n.getUint8(h)+1;;){if(s=(r=n.getUint8(h))&(o?31:63),a===i)return s;if(s===e)return h+(!o&&128&r?2:1);if(s<e)return 0;a=s,h+=o?2+(r>>5):128&r?(s=63&n.getUint8(h+1))?s+2:66:64&r?3:2}},gestalt:function(t){switch(t){case 1:return 258}return 0},get_child:function(t){return this.version3?this.m.getUint8(this.objects+9*t+6):this.m.getUint16(this.objects+14*t+10)},get_sibling:function(t){return this.version3?this.m.getUint8(this.objects+9*t+5):this.m.getUint16(this.objects+14*t+8)},get_parent:function(t){return this.version3?this.m.getUint8(this.objects+9*t+4):this.m.getUint16(this.objects+14*t+6)},get_prop:function(t,e){var i,r=this.m,s=this.find_prop(t,e);return s?(i=r.getUint8(s-1),r[(this.version3?i>>5:64&i)?"getUint16":"getUint8"](s)):r.getUint16(this.properties+2*(e-1))},get_prop_len:function(t){if(0===t)return 0;var e=this.m.getUint8(t-1);return this.version3?1+(e>>5):128&e?0===(e&=63)?64:e:64&e?2:1},incdec:function(t,e){if(0===t)return this.s[this.sp-1]+=e,this.s[this.sp-1];if(--t<15)return this.l[t]+=e,this.l[t];var i=this.globals+2*(t-15);return this.ram.setUint16(i,this.m.getUint16(i)+e),this.ram.getUint16(i)},indirect:function(t,e){return 0===t?arguments.length>1?this.s[this.sp-1]=e:this.s[this.sp-1]:this.variable(t,e)},insert_obj:function(t,e){this.remove_obj(t),this.set_family(t,e,e,t,t,this.get_child(e))},jeq:function(){for(var t=1;t<arguments.length;)if(arguments[t++]===arguments[0])return 1},jin:function(t,e){return this.get_parent(t)===e},log:function(t){this.options.GlkOte&&this.options.GlkOte.log(t)},log_shift:function(t,e){return e>0?t<<e:t>>>-e},make_stacks:function(){var t=15&this.stack.getUint8(this.frameptr+3);this.l=new Uint16Array(this.stack.buffer,this.frameptr+8,t),this.s=new Uint16Array(this.stack.buffer,this.frameptr+8+2*t)},put_prop:function(t,e,i){var r,s=this.find_prop(t,e);s&&(r=this.m.getUint8(s-1),this.ram[(this.version3?r>>5:64&r)?"setUint16":"setUint8"](s,i))},random:function(t){var e=this.xorshift_seed;return t<1?(this.xorshift_seed=t,0):0===e?1+Math.random()*t|0:(e^=e<<13,e^=e>>17,this.xorshift_seed=e^=e<<5,1+(32767&e)%t)},remove_obj:function(t){var e,i,r,s=this.get_parent(t);if(0!==s)if(e=this.get_child(s),i=this.get_sibling(t),e===t)this.set_family(t,0,s,i);else{for(;(r=this.get_sibling(e))!==t;)e=r;this.set_family(t,0,0,0,e,i)}},restart:function(){var t=this.ram,e=t.getUint8(0),i=3===e,r=i?2:8===e?8:4,s=t.getUint8(17),n=t.getUint16(10),o=e>4?t.getUint16(54):0,a=utils.MemoryView(this.options.stack_len);t.setUint8Array(0,this.origram),t.setUint8(17,s),extend$1(this,{stack:a,frameptr:0,frames:[],s:new Uint16Array(a.buffer,8),sp:0,l:[],undo:[],undo_len:0,glk_blocking_call:null,version:e,version3:i,pc:t.getUint16(6),properties:n,objects:n+(i?53:112),globals:t.getUint16(12),eof:(t.getUint16(26)||65536)*r,extension:o,extension_count:o?t.getUint16(o):0,addr_multipler:r,opcodes:opcodes(e)}),this.init_text(),this.init_io(),this.update_header()},restore:function(t){this.pc=t,this.fileref_create_by_prompt({func:"restore",mode:2,usage:1})},restore_file:function(t,e){var i,r=this.ram,s=new file.Quetzal(t),n=s.memory,o=this.stack,a=r.getUint8(17),h=0,u=0;if(r.getUint16(2)!==s.release||r.getUint16(28)!==s.checksum)return 0;for(;h<6;)if(r.getUint8(18+h)!==s.serial[h++])return 0;if(h=0,r.setUint8Array(0,this.origram),s.compressed)for(;h<n.length;)0===(i=n[h++])?u+=1+n[h++]:r.setUint8(u,i^this.origram[u++]);else r.setUint8Array(0,n);for(r.setUint8(17,a),o.setUint8Array(0,s.stacks),this.frames=[],h=0;h<s.stacks.byteLength;)this.frameptr=h,this.frames.push(h),fix_stack_endianness(o,u=h+8,u+=2*(15&o.getUint8(h+3)),e),fix_stack_endianness(o,u,u+=2*o.getUint16(h+6),e),h=u;return this.frames.pop(),this.sp=o.getUint16(this.frameptr+6),this.make_stacks(),this.pc=s.pc,this.update_header(),this.version3&&this.split_window(0),2},restore_undo:function(){if(0===this.undo.length)return 0;var t=this.undo.pop();return this.frameptr=t.frameptr,this.pc=t.pc,this.undo_len-=t.ram.byteLength+t.stack.byteLength,t.ram[17]=this.m.getUint8(17),this.ram.setUint8Array(0,t.ram),this.frames=t.frames,this.sp=t.sp,this.stack.setUint8Array(0,t.stack),this.make_stacks(),this.variable(t.var,2),1},ret:function(t){var e=this.stack,i=this.frameptr,r=16&e.getUint8(i+3)?-1:e.getUint8(i+4);this.pc=e.getUint32(i)>>8,i=this.frameptr=this.frames.pop(),this.make_stacks(),this.sp=e.getUint16(i+6),r>=0&&this.variable(r,t||0)},save:function(t){this.pc=t,this.fileref_create_by_prompt({func:"save",mode:1,usage:1})},save_file:function(t,e){var i,r,s,n=this.m,o=new file.Quetzal,a=utils.MemoryView(this.stack.buffer.slice()),h=0,u=this.frameptr;if(o.release=n.getUint16(2),o.serial=n.getUint8Array(18,6),o.checksum=n.getUint16(28),o.pc=t,e)o.memory=this.m.getUint8Array(0,this.staticmem);else{const t=[];for(o.compressed=1,i=0;i<this.staticmem;i++)0===(s=n.getUint8(i)^this.origram[i])?256==++h&&(t.push(0,255),h=0):(h&&(t.push(0,h-1),h=0),t.push(s));o.memory=t}if(a.setUint16(u+6,this.sp),littleEndian&&!e){const t=this.frames.slice();for(t.push(u),i=0;i<t.length;i++)fix_stack_endianness(a,r=(u=t[i])+8,r+=2*(15&a.getUint8(u+3))),fix_stack_endianness(a,r,r+=2*a.getUint16(u+6))}return o.stacks=a.getUint8Array(0,this.frameptr+8+2*(15&a.getUint8(u+3))+2*this.sp),o.write()},save_restore_handler:function(t){var e,i,r,s=this.m,n=this.Glk,o=0,a=[];t&&("save"===this.fileref_data.func?(n.glk_put_buffer_stream(t,new Uint8Array(this.save_file(this.pc))),o=1):(a=new Uint8Array(131072),n.glk_get_buffer_stream(t,a),o=this.restore_file(a.buffer)),n.glk_stream_close(t)),this.version3?(i=128&(e=s.getUint8(this.pc++)),r=64&e?63&e:(e<<8|s.getUint8(this.pc++))<<18>>18,!o==!i&&(0===r||1===r?this.ret(r):this.pc+=r-2)):this.variable(s.getUint8(this.pc++),o)},save_undo:function(t,e){var i;return this.undo_len>this.options.undo_len&&(i=this.undo.shift(),this.undo_len-=i.ram.byteLength+i.stack.byteLength),i={frameptr:this.frameptr,frames:this.frames.slice(),pc:t,ram:this.m.getUint8Array(0,this.staticmem),sp:this.sp,stack:this.stack.getUint8Array(0,this.s.byteOffset+2*this.sp),var:e},this.undo_len+=i.ram.byteLength+i.stack.byteLength,this.undo.push(i),1},scan_table:function(t,e,i,r){var s=128&(r=r||130)?"getUint16":"getUint8";for(i=e+i*(r&=127);e<i;){if(this.m[s](e)===t)return e;e+=r}return 0},set_attr:function(t,e){var i=this.objects+(this.version3?9:14)*t+e/8|0;this.ram.setUint8(i,this.m.getUint8(i)|128>>e%8)},set_family:function(t,e,i,r,s,n){var o=this.ram,a=this.objects;this.version3?(o.setUint8(a+9*t+4,e),i&&o.setUint8(a+9*i+6,r),s&&o.setUint8(a+9*s+5,n)):(o.setUint16(a+14*t+6,e),i&&o.setUint16(a+14*i+10,r),s&&o.setUint16(a+14*s+8,n))},test:function(t,e){return(t&e)===e},test_attr:function(t,e){return this.m.getUint8(this.objects+(this.version3?9:14)*t+e/8|0)<<e%8&128},variable:function(t,e){var i,r=void 0!==e;if(0===t){if(!r)return this.s[--this.sp];this.s[this.sp++]=e}else if(--t<15){if(!r)return this.l[t];this.l[t]=e}else{if(i=this.globals+2*(t-15),!r)return this.m.getUint16(i);this.ram.setUint16(i,e)}return e},U2S:U2S$1,S2U:S2U},text={init_text:function(){var t=this,e=this.m,i=this.version>4&&e.getUint16(52),r=this.extension_table(3),s=r&&e.getUint8(r++);this.abbr_addr=e.getUint16(24),function(e){for(var i=[[],[],[]],r=0;r<78;)i[r/26|0][r%26]=e[r++];i[2][1]=13,t.alphabets=i}(i?e.getUint8Array(i,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()",1)),function(e){for(var i={13:"\r"},r={13:13},s=0;s<e.length;)i[155+s]=String.fromCharCode(e[s]),r[e[s]]=155+s++;for(s=32;s<127;)i[s]=String.fromCharCode(s),r[s]=s++;t.unicode_table=i,t.reverse_unicode_table=r}(r?e.getUint16Array(r,s):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1)),this.dictionaries={},this.dict=e.getUint16(8),this.parse_dict(this.dict)},decode:function(t,e){var i,r,s,n=this.m,o=t,a=[],h=0,u=0,c=[],l=[],p=0;if(this.jit[t])return this.jit[t];for(e=e?e+t:this.eof;t<e&&(i=n.getUint16(t),t+=2,a.push(i>>10&31,i>>5&31,31&i),!(32768&i)););for(;h<a.length;)0===(r=a[h++])?c.push(32):r<4?(s=1,c.push(-1),l.push("+this.abbr("+(32*(r-1)+a[h++])+")+")):r<6?u=r:2===u&&6===r?h+1<a.length&&c.push(a[h++]<<5|a[h++]):r<32&&c.push(this.alphabets[u][r-6]),u=u<4?0:u-3,h%3==0&&(h+=p,p=0);return c=this.zscii_to_text(c,l),s&&(c={toString:Function('return"'+c.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\r/g,"\\r").replace(/\uE000/g,'"')+'"').bind(this)}),o>=this.staticmem&&(this.jit[o]=c),c},encode:function(t){for(var e,i,r=this.alphabets,s=[],n=this.version3?6:9,o=0,a=[];s.length<n;)32===(e=t[o++])?s.push(0):(i=r[0].indexOf(e))>=0?s.push(i+6):(i=r[1].indexOf(e))>=0?s.push(4,i+6):(i=r[2].indexOf(e))>=0?s.push(5,i+6):void 0===e?s.push(5):s.push(5,6,e>>5,31&e);for(s.length=n,o=0;o<n;)a.push(s[o++]<<2|s[o]>>3,(7&s[o++])<<5|s[o++]);return a[a.length-2]|=128,a},zscii_to_text:function(t,e){for(var i,r=0,s=t.length,n=0,o="";r<s;)-1===(i=t[r++])&&(o+=e[n++]),(i=this.unicode_table[i])&&(o+=i);return o},text_to_zscii:function(t,e){for(var i,r=[],s=0,n=t.length;s<n;)i=t.charCodeAt(s++),e||(i=this.reverse_unicode_table[i]||63),r.push(i);return r},parse_dict:function(t){var e,i,r=this.m,s=t,n={},o=r.getUint8(t++);for(n.separators=Array.prototype.slice.call(r.getUint8Array(t,o)),t+=o,e=r.getUint8(t++),i=t+2+e*r.getUint16(t),t+=2;t<i;)n[Array.prototype.toString.call(r.getUint8Array(t,this.version3?4:6))]=t,t+=e;return this.dictionaries[s]=n,n},abbr:function(t){return this.decode(2*this.m.getUint16(this.abbr_addr+2*t))},tokenise:function(t,e,i,r){i=i||this.dict,i=this.dictionaries[i]||this.parse_dict(i);var s,n,o,a,h=this.m,u=this.ram,c=1e3,l=1,p=i.separators,_=[],d=0;for(this.version>4&&(c=h.getUint8(t+l++)+2);l<c&&0!==(s=h.getUint8(t+l));)32===s||p.indexOf(s)>=0?(32!==s&&_.push([[s],l]),n=null):(n||(_.push([[],l]),n=_[_.length-1][0]),n.push(s)),l++;for(o=Math.min(_.length,h.getUint8(e));d<o;)a=i[""+this.encode(_[d][0])],r&&!a||(u.setUint16(e+2+4*d,a||0),u.setUint8(e+4+4*d,_[d][0].length),u.setUint8(e+5+4*d,_[d][1])),d++;u.setUint8(e+1,d)}};const U2S$2=utils.U2S16,ZSCII_keyCodes=function(){for(var t={4294967289:8,4294967290:13,4294967288:27,4294967292:129,4294967291:130,4294967294:131,4294967293:132,4294967283:146,4294967285:148,4294967284:152,4294967286:154},e=0;e<12;)t[4294967279-e]=133+e++;return t}(),style_mappings=[0,2,1,10,4,9,5,6];function convert_true_colour(t){const e=[0,8,16,25,33,41,49,58,66,74,82,90,99,107,115,123,132,140,148,156,165,173,181,189,197,206,214,222,230,239,247,255];return e[31&t]<<16|e[(992&t)>>5]<<8|e[(31744&t)>>10]}const zcolours=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627];var io={init_io:function(){this.io=this.io||{reverse:0,bold:0,italic:0,mono:2&this.m.getUint8(17),transcript:1&this.m.getUint8(17),streams:[0,1,{},[],{}],currentwin:0,height:0,maxheight:0,seenheight:0,width:0,row:0,col:0},this.open_windows()},erase_line:function(t){if(1===t){var e=this.io,i=e.row,r=e.col;this._print(Array(e.width-e.col+1).join(" ")),this.set_cursor(i,r)}},erase_window:function(t){t<1&&this.Glk.glk_window_clear(this.mainwin),1!==t&&-2!==t||this.upperwin&&(this.Glk.glk_window_clear(this.upperwin),this.set_cursor(0,0)),-1===t&&this.split_window(0)},fileref_create_by_prompt:function(t){void 0===t.run&&(t.run=1),this.fileref_data=t,this.glk_blocking_call="fileref_create_by_prompt",this.Glk.glk_fileref_create_by_prompt(t.usage,t.mode,t.rock||0)},fix_upper_window:function(){var t=this.Glk,e=this.io;e.seenheight>=e.maxheight&&(e.maxheight=e.height),this.upperwin&&(0===e.maxheight?(t.glk_window_close(this.upperwin),this.upperwin=null):t.glk_window_set_arrangement(t.glk_window_get_parent(this.upperwin),18,e.maxheight,null)),e.seenheight=e.maxheight,e.maxheight=e.height},format:function(){this.Glk.glk_set_style(style_mappings[!!this.io.mono|this.io.italic|this.io.bold]),this.Glk.glk_gestalt(4352,0)&&this.Glk.garglk_set_reversevideo(this.io.reverse)},get_cursor:function(t){this.ram.setUint16(t,this.io.row+1),this.ram.setUint16(t+2,this.io.col+1)},handle_char_input:function(t){var e=this.io.streams[4],i=ZSCII_keyCodes[t]||this.reverse_unicode_table[t]||63;this.variable(this.read_data.storer,i),1===e.mode&&(e.cache+=i),2===e.mode&&this.Glk.glk_put_char_stream_uni(e.str,i)},handle_create_fileref:function(t){var e,i=this.Glk,r=this.fileref_data;return t&&(e=r.unicode?i.glk_stream_open_file_uni(t,r.mode,r.rock||0):i.glk_stream_open_file(t,r.mode,r.rock||0),i.glk_fileref_destroy(t)),"restore"!==r.func&&"save"!==r.func||this.save_restore_handler(e),"input_stream"===r.func&&(this.io.streams[0]=e),"output_stream"===r.func&&this.output_stream_handler(e),r.run},handle_line_input:function(t,e){var i=this.ram,r=this.read_data,s=this.io.streams,n=String.fromCharCode.apply(null,r.buffer.slice(0,t))+"\n",o=this.text_to_zscii(n.slice(0,-1).toLowerCase());1===s[2].mode&&(s[2].cache+=n),2===s[2].mode&&this.Glk.glk_put_jstring_stream(s[2].str,n),1===s[4].mode&&(s[4].cache+=n),2===s[4].mode&&this.Glk.glk_put_jstring_stream(s[4].str,n),this.version<5?(o.push(0),i.setUint8Array(r.bufaddr+1,o)):(i.setUint8(r.bufaddr+1,t),i.setUint8Array(r.bufaddr+2,o),this.variable(r.storer,isNaN(e)?13:e)),r.parseaddr&&this.tokenise(r.bufaddr,r.parseaddr)},input_stream:function(t){var e=this.io;t&&!e.streams[0]&&this.fileref_create_by_prompt({func:"input_stream",mode:2,rock:212,unicode:1,usage:259}),!t&&e.streams[0]&&(this.Glk.glk_stream_close(e.streams[0]),e.streams[0]=0)},open_windows:function(){if(!this.mainwin){const t=this.Glk,e=[1,2,4,5,6,9,10];for(let i=0;i<7;i++)t.glk_stylehint_set(0,e[i],3,0),t.glk_stylehint_set(0,e[i],4,0),t.glk_stylehint_set(0,e[i],5,0),t.glk_stylehint_set(0,e[i],6,1);t.glk_stylehint_set(0,4,4,1),t.glk_stylehint_set(0,1,5,1),t.glk_stylehint_set(0,5,4,1),t.glk_stylehint_set(0,5,5,1),t.glk_stylehint_set(0,2,6,0),t.glk_stylehint_set(0,9,4,1),t.glk_stylehint_set(0,9,6,0),t.glk_stylehint_set(0,10,5,1),t.glk_stylehint_set(0,10,6,0),t.glk_stylehint_set(0,6,4,1),t.glk_stylehint_set(0,6,5,1),t.glk_stylehint_set(0,6,6,0),this.mainwin=t.glk_window_open(0,0,0,3,201),t.glk_set_window(this.mainwin),this.version3&&(this.statuswin=t.glk_window_open(this.mainwin,18,1,4,202),this.statuswin&&t.garglk_set_reversevideo_stream(t.glk_window_get_stream(this.statuswin),1))}},output_stream:function(t,e,i){var r,s,n=this.ram,o=this.io.streams;1===(t=U2S$2(t))&&(o[1]=1),-1===t&&(o[1]=0),2!==t||o[2].mode||(this.fileref_create_by_prompt({func:"output_stream",mode:5,rock:210,run:!i,str:2,unicode:1,usage:258}),o[2].cache="",o[2].mode=1,i||(this.stop=1)),-2===t&&(n.setUint8(17,254&n.getUint8(17)),2===o[2].mode&&this.Glk.glk_stream_close(o[2].str),o[2].mode=this.io.transcript=0),3===t&&o[3].unshift([e,""]),-3===t&&(r=o[3].shift(),s=this.text_to_zscii(r[1]),n.setUint16(r[0],s.length),n.setUint8Array(r[0]+2,s)),4!==t||o[4].mode||(this.fileref_create_by_prompt({func:"output_stream",mode:5,rock:211,str:4,unicode:1,usage:259}),o[4].cache="",o[4].mode=1,this.stop=1),-4===t&&(2===o[4].mode&&this.Glk.glk_stream_close(o[4].str),o[4].mode=0)},output_stream_handler:function(t){var e=this.ram,i=this.io.streams,r=this.fileref_data;2===r.str&&(e.setUint8(17,254&e.getUint8(17)|(t?1:0)),t?(i[2].mode=2,i[2].str=t,this.io.transcript=1,i[2].cache&&this.Glk.glk_put_jstring_stream(i[2].str,i[2].cache)):i[2].mode=this.io.transcript=0),4===r.str&&(t?(i[4].mode=2,i[4].str=t,i[4].cache&&this.Glk.glk_put_jstring_stream(i[4].str,i[4].cache)):i[4].mode=0)},_print:function(t){var e=this.Glk,i=this.io,r=0;if(i.streams[3].length)i.streams[3][0][1]+=t;else if(t=t.replace(/\r/g,"\n"),(1&this.m.getUint8(17))!==i.transcript&&this.output_stream(i.transcript?-2:2,0,1),(2&this.m.getUint8(17))!=(2&i.mono)&&(i.mono^=2,this.format()),i.currentwin&&this.upperwin)for(;r<t.length&&i.row<i.height;)e.glk_put_jstring(t[r++]),i.col++,i.col===i.width&&(i.col=0,i.row++);else i.currentwin||(i.streams[1]&&e.glk_put_jstring(t),1===i.streams[2].mode&&(i.streams[2].cache+=t),2===i.streams[2].mode&&e.glk_put_jstring_stream(i.streams[2].str,t))},print:function(t,e){var i,r;if(0===t&&(r=e),1===t&&(r=String.fromCharCode(e)),2===t&&(r=this.jit[e]||this.decode(e)),3===t&&(i=this.m.getUint16(this.objects+(this.version3?9:14)*e+(this.version3?7:12)),r=this.decode(i+1,2*this.m.getUint8(i))),4===t){if(!this.unicode_table[e])return;r=this.unicode_table[e]}this._print(""+r)},print_table:function(t,e,i,r){i=i||1,r=r||0;for(var s=0;s++<i;)this._print(this.zscii_to_text(this.m.getUint8Array(t,e))+(s<i?"\r":"")),t+=e+r},read:function(t,e,i,r,s){var n,o,a=this.m.getUint8(e);if(this.version3&&(a++,this.v3_status()),(n=Array(a)).fill(0),this.read_data={buffer:n,bufaddr:e,parseaddr:i,routine:s,storer:t,time:r},this.io.streams[0]){if(10===n[(o=this.Glk.glk_get_line_stream_uni(this.io.streams[0],n))-1]&&o--,o)return this._print(String.fromCharCode.apply(null,n.slice(0,o))+"\n"),this.handle_line_input(o),this.stop=0;this.input_stream(0)}this.Glk.glk_request_line_event_uni(this.io.currentwin?this.upperwin:this.mainwin,n,0),this.fix_upper_window()},read_char:function(t,e,i,r){if(this.io.streams[0]){var s=this.Glk.glk_get_char_stream_uni(this.io.streams[0]);if(-1!==s)return this.variable(t,s),this.stop=0;this.input_stream(0)}this.read_data={routine:r,storer:t,time:i},this.Glk.glk_request_char_event_uni(this.io.currentwin?this.upperwin:this.mainwin),this.fix_upper_window()},set_colour:function(t,e){this.set_true_colour(zcolours[t],zcolours[e])},set_cursor:function(t,e){var i=this.io;i.currentwin&&(t>=i.height&&this.split_window(t+1),this.upperwin&&t>=0&&e>=0&&e<i.width&&(this.Glk.glk_window_move_cursor(this.upperwin,e,t),i.row=t,i.col=e))},set_font:function(t){var e=4&this.io.mono?4:1;return 0===t?e:1!==t&&4!==t?0:(t!==e&&(this.io.mono^=4,this.format()),e)},set_style:function(t){var e=this.io;0===t&&(e.reverse=e.bold=e.italic=0,e.mono&=254),1&t&&(e.reverse=1),2&t&&(e.bold=4),4&t&&(e.italic=2),8&t&&(e.mono|=1),this.format()},set_true_colour:function(t,e){const i=this.Glk;if(i.glk_gestalt(4352,0)){let r,s;65534===t?r=-2:65535===t?r=-1:(r=convert_true_colour(t),i.glk_stylehint_set(0,0,7,r)),65534===e?s=-2:65535===e?s=-1:(s=convert_true_colour(e),i.glk_stylehint_set(0,0,8,s)),i.garglk_set_zcolors_stream(this.mainwin.str,r,s),this.upperwin&&i.garglk_set_zcolors_stream(this.upperwin.str,r,s),this.statuswin&&i.garglk_set_zcolors_stream(this.statuswin.str,r,s)}},set_window:function(t){this.io.currentwin=t,t&&this.set_cursor(0,0),this.Glk.glk_set_window(this.upperwin&&t?this.upperwin:this.mainwin),this.format()},split_window:function(t){var e,i=this.Glk,r=this.io,s=r.row,n=r.col,o=r.height;if(r.height=t,this.upperwin&&t>o){for(e=i.glk_window_get_stream(this.upperwin);o<t;)i.glk_window_move_cursor(this.upperwin,0,o++),i.glk_put_jstring_stream(e,Array(r.width+1).join(" "));i.glk_window_move_cursor(this.upperwin,n,s)}t>r.maxheight&&(r.maxheight=t,this.upperwin?i.glk_window_set_arrangement(i.glk_window_get_parent(this.upperwin),18,r.maxheight,null):this.upperwin=i.glk_window_open(this.mainwin,18,r.maxheight,4,203)),t&&(r.row>=t&&this.set_cursor(0,0),this.version3&&i.glk_window_clear(this.upperwin))},update_header:function(){var t=this.ram;if(this.xorshift_seed=0,this.update_screen_size(),this.version3)return t.setUint8(1,143&t.getUint8(1)|(this.statuswin?32:16)|64);t.setUint8(1,28|(this.Glk.glk_gestalt(4352,0)?1:0)),t.setUint8(17,87&t.getUint8(17)),this.version>4&&t.setUint16(38,257),t.setUint16(50,258),this.extension_table(4,0)},update_screen_size:function(){const t=this.Glk,e=new t.RefBox,i=new t.RefBox,r=t.glk_window_open(this.mainwin,18,0,4,0);let s=0,n=0;t.glk_window_get_size(this.mainwin,i,e),s=e.get_value(),this.upperwin&&(t.glk_window_get_size(this.upperwin,i,e),s+=e.get_value()),this.statuswin&&(t.glk_window_get_size(this.statuswin,i,e),s+=e.get_value()),r&&(t.glk_window_get_size(r,i,0),t.glk_window_close(r)),n=i.get_value(),s=Math.min(s,254),n=this.io.width=Math.min(n,255),this.version>3&&(this.ram.setUint8(32,s),this.ram.setUint8(33,n)),this.version>4&&(this.ram.setUint16(34,n),this.ram.setUint16(36,s)),this.io.col>=n&&(this.io.col=n-1)},v3_status:function(){if(this.statuswin){var t,e=this.Glk,i=e.glk_window_get_stream(this.statuswin),r=this.m,s=this.io.width,n=r.getUint16(this.globals+2),o=r.getUint16(this.globals+4),a=r.getUint16(this.objects+9*r.getUint16(this.globals)+7),h=""+this.decode(a+1,2*r.getUint8(a));t=2&r.getUint8(1)?"Time: "+(n%12==0?12:n%12)+":"+(o<10?"0":"")+o+" "+(n>11?"PM":"AM"):"Score: "+n+"  Turns: "+o,e.glk_window_move_cursor(this.statuswin,0,0),e.glk_put_jstring_stream(i,Array(s+1).join(" ")),e.glk_window_move_cursor(this.statuswin,0,0),e.glk_put_jstring_stream(i," "+h.slice(0,s-t.length-4)),e.glk_window_move_cursor(this.statuswin,s-t.length-1,0),e.glk_put_jstring_stream(i,t)}}},disassemble=function(){var t,e,i,r,s,n,o,a=this.m,h=this.opcodes,u=new ast.RoutineContext(this,this.pc);function c(t,e){for(var i=0;i<4;i++)e.push((192&t)>>6),t<<=2}for(;;){if(e=t=this.pc,190===(r=a.getUint8(t++))?(n=-1,r=a.getUint8(t++)+1e3):128&r?64&r?(n=-1,32&r||(r&=31)):(n=[(48&r)>>4])[0]<3&&(r&=207):(n=[64&r?2:1,32&r?2:1],r&=31),!h[r])throw this.log(""+u),this.stop=1,new Error("Unknown opcode #"+r+" at pc="+e);for(s=h[r].prototype,-1===n&&(n=[],c(a.getUint8(t++),n),236!==r&&250!==r||c(a.getUint8(t++),n)),o=[],i=0;i<n.length;)0===n[i]&&(o.push(new ast.Operand(this,a.getUint16(t))),t+=2),1===n[i]&&o.push(new ast.Operand(this,a.getUint8(t++))),2===n[i++]&&o.push(new ast.Variable(this,a.getUint8(t++)));if(s.storer&&o.push(new ast.Variable(this,a.getUint8(t++))),s.brancher&&(i=a.getUint8(t++),o.push([128&i,64&i?63&i:(i<<8|a.getUint8(t++))<<18>>18])),s.printer)for(o.push(t);t<this.eof&&(i=a.getUint8(t),t+=2,!(128&i)););if(this.pc=t,u.ops.push(new h[r](this,u,r,e,t,o)),i=0,s.stopper&&!i)break}return u},disassembler={disassemble:disassemble},default_options={stack_len:1e5,undo_len:1e6},api={init:function(){this.jit={},this.init=this.start},prepare:function(t,e){if(!e.Glk)throw new Error("A reference to Glk is required");this.Glk=e.Glk,this.data=t,this.options=utils.extend({},default_options,e)},start:function(){var t,e=this.Glk;try{if(t=file.identify(this.data),delete this.data,!t||"ZCOD"!==t.format)throw new Error("This is not a Z-Code file");if([3,4,5,8].indexOf(t.version)<0)throw new Error("Unsupported Z-Machine version: "+t.version);this.m=utils.MemoryView(t.data),this.staticmem=this.m.getUint16(14),this.ram=utils.MemoryView(this.m,0,this.staticmem),this.origram=this.m.getUint8Array(0,this.staticmem);let i,r="",s=0;for(;s<30;)r+=(this.origram[s]<16?"0":"")+this.origram[s++].toString(16);this.signature=r;const n=this.options.Dialog;if(n)if(this.options.clear_vm_autosave)n.autosave_write(r,null);else if(this.options.do_vm_autosave)try{const t=n.autosave_read(r);t&&(this.do_autorestore(t),i=1)}catch(t){this.log("Autorestore failed, deleting it"),n.autosave_write(r,null)}i||(this.restart(),this.run()),this.quit||(this.glk_event=new e.RefStruct,this.glk_blocking_call?this.glk_event.push_field(this.glk_blocking_call):e.glk_select(this.glk_event)),e.update()}catch(t){e.fatal_error(t),console.log(t)}},resume:function(t){var e,i,r=this.Glk,s=this.glk_event;try{2===(e=s.get_field(0))&&(this.handle_char_input(s.get_field(2)),i=1),3===e&&(this.handle_line_input(s.get_field(2),s.get_field(3)),i=1),5===e&&this.update_screen_size(),"fileref_create_by_prompt"===e&&(i=this.handle_create_fileref(t)),this.glk_blocking_call=null,i&&this.run(),this.quit||(this.glk_event=new r.RefStruct,this.glk_blocking_call?this.glk_event.push_field(this.glk_blocking_call):r.glk_select(this.glk_event)),r.update()}catch(t){r.fatal_error(t),console.log(t)}},get_signature:function(){return this.signature},run:function(){var t,e;for(this.stop=0;!this.stop;)t=this.pc,this.jit[t]||this.compile(),e=this.jit[t](this),isNaN(e)||this.ret(e)},compile:function(){var t=this.disassemble();this.jit[t.pc]=new Function("e",""+t),t.pc<this.staticmem&&this.log("Caching a JIT function in dynamic memory: "+t.pc)}},VM=utils.Class.subClass(utils.extend(api,runtime,text,io,disassembler)),zvm=VM,dispatch=createCommonjsModule((function(t){const e={serialize:()=>({})};class i{constructor(){this.class_map={fileref:{},stream:{},window:{}},this.last_used_id=101}check_autosave(){return!this.vm.glk_blocking_call}class_obj_from_id(t,e){return this.class_map[t][e]}class_register(t,e,i){if(i){if(e.disprock!==i)throw new Error("class_register: object is not already registered");this.last_used_id<=i&&(this.last_used_id=i+1)}else{if(e.disprock)throw new Error("class_register: object is already registered");e.disprock=this.last_used_id++}this.class_map[t][e.disprock]=e}class_unregister(t,e){if(!e.disprock||null==this.class_map[t][e.disprock])throw new Error("class_unregister: object is not registered");delete this.class_map[t][e.disprock],e.disprock=null}get_retained_array(t){return{arg:e,arr:t.slice(),len:t.length}}prepare_resume(){}retain_array(){}set_vm(t){this.vm=t}unretain_array(){}}t.exports&&(t.exports=i),"undefined"!=typeof window&&(window.GiDispa=new i)}));window.ZVM=zvm,window.ZVMDispatch=dispatch;